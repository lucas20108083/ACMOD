name: RWAC packager - Manual Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release

permissions:
  contents: write
  releases: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: powershell
        run: |
          $version = (Get-Content ver.txt).Trim()
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Output "Version: $version"

      - name: Build mod
        shell: powershell
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $buildType = "${{ github.event.inputs.build_type }}"
          
          if (-not (Test-Path "Build")) {
            New-Item -ItemType Directory -Path "Build" -Force | Out-Null
          }
          
          $zipFile = "Build/ACMod-Sunset_and_shimmer_${version}_${buildType}.zip"
          $rwmodFile = "Build/ACMod-Sunset_and_shimmer_${version}_${buildType}.rwmod"
          
          Write-Output "Building $buildType..."
          Compress-Archive -Path "ACMod-Sunset_and_shimmer/*" -DestinationPath $zipFile -CompressionLevel Optimal -Force
          Rename-Item -Path $zipFile -NewName (Split-Path $rwmodFile -Leaf) -Force
          
          Write-Output "✅ Build completed: $(Split-Path $rwmodFile -Leaf)"

      - name: Delete old release
        run: |
          $tag = "v${{ steps.version.outputs.version }}"
          if (gh release view "$tag" > $null 2>&1) {
            gh release delete "$tag" -y || $true
            git push origin ":refs/tags/$tag" || $true
          }
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Create Release
        run: |
          $tag = "v${{ steps.version.outputs.version }}"
          gh release create "$tag" `
            --title "ACMod Sunset and Shimmer ${{ steps.version.outputs.version }} (${{ github.event.inputs.build_type }})" `
            --notes "自动发行版本 - Auto Release`n构建类型 / Build Type: ${{ github.event.inputs.build_type }}`n版本号 / Version: ${{ steps.version.outputs.version }}" `
            Build/*.rwmod
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
