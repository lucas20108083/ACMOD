name: Auto Release Build

on:
  push:
    branches:
      - main
    paths:
      - 'Build/*.rwmod'
      - 'ver.txt'
      - '.github/workflows/release.yml'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from ver.txt
        id: version
        run: |
          VERSION=$(cat ver.txt | tr -d '\n' | tr -d '\r')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Find and delete existing release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="v${{ steps.version.outputs.version }}"
          
          # Check if release exists
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Deleting existing release: $RELEASE_TAG"
            gh release delete "$RELEASE_TAG" -y
          else
            echo "No existing release found for tag: $RELEASE_TAG"
          fi

      - name: Get release files
        id: files
        run: |
          FILES=$(ls -1 Build/*.rwmod 2>/dev/null | head -1)
          if [ -z "$FILES" ]; then
            echo "No .rwmod files found in Build directory!"
            exit 1
          fi
          echo "files=${FILES}" >> $GITHUB_OUTPUT
          echo "Found file: ${FILES}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            自动发行版本 - Auto Release
            
            版本号 / Version: ${{ steps.version.outputs.version }}
            
            此版本已自动构建和发布。
            This version has been automatically built and published.
          files: Build/*.rwmod
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release completed
        run: |
          echo "✅ Release v${{ steps.version.outputs.version }} published successfully!"
